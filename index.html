<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Trigonometric Audit: Pavilion Stability Inspector</title>
   <script src="https://cdn.tailwindcss.com"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
   <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
   <style>
       body { font-family: 'Inter', sans-serif; background: #f5f5f0; color: #1a1a1a; overflow: hidden; }
       .mono { font-family: 'JetBrains Mono', monospace; }
       .glass-panel {
           background: rgba(255, 255, 255, 0.9);
           backdrop-filter: blur(12px);
           border: 1px solid rgba(0, 0, 0, 0.1);
           box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
       }
       .hud-text { text-shadow: 0 0 10px rgba(0, 100, 255, 0.3); }
       .tool-active { 
           background: rgba(0, 100, 255, 0.1); 
           border-color: #0066ff; 
           color: #0066ff; 
       }
       .measurement-line {
           position: absolute;
           background: #ff3300;
           transform-origin: left center;
           height: 2px;
           pointer-events: none;
           opacity: 0;
           transition: opacity 0.3s;
       }
       .measurement-label {
           position: absolute;
           background: rgba(255, 255, 255, 0.95);
           color: #ff3300;
           padding: 4px 8px;
           border-radius: 4px;
           font-size: 12px;
           pointer-events: none;
           opacity: 0;
           transition: opacity 0.3s;
           border: 1px solid #ff3300;
           font-weight: bold;
       }
       .warning-pulse { animation: pulse-red 2s infinite; }
       @keyframes pulse-red {
           0%, 100% { box-shadow: 0 0 0 0 rgba(255, 50, 50, 0.4); }
           50% { box-shadow: 0 0 0 10px rgba(255, 50, 50, 0); }
       }
       #canvas-container { cursor: crosshair; }
       .math-step { 
           border-left: 3px solid #0066ff; 
           padding-left: 1rem; 
           margin: 0.5rem 0; 
           background: rgba(0, 102, 255, 0.05);
           padding: 0.75rem;
           border-radius: 0 8px 8px 0;
       }
       .triangle-highlight { filter: drop-shadow(0 0 8px rgba(0, 102, 255, 0.8)); }
       
       /* Custom scrollbar for report */
       ::-webkit-scrollbar { width: 8px; }
       ::-webkit-scrollbar-track { background: #f1f1f1; }
       ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
       ::-webkit-scrollbar-thumb:hover { background: #999; }

       .btn-primary {
           background: #1a1a1a;
           color: white;
           transition: all 0.3s;
       }
       .btn-primary:hover {
           background: #0066ff;
           transform: translateY(-1px);
           box-shadow: 0 4px 12px rgba(0, 102, 255, 0.3);
       }
       
       .status-badge {
           background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
           color: white;
           padding: 0.25rem 0.75rem;
           border-radius: 9999px;
           font-size: 0.75rem;
           font-weight: 600;
       }
   </style>
</head>
<body class="h-screen w-screen relative">

   <!-- 3D Canvas -->
   <div id="canvas-container" class="absolute inset-0 z-0"></div>

   <!-- HUD Overlay -->
   <div class="absolute inset-0 z-10 pointer-events-none flex flex-col justify-between p-6">
       
       <!-- Top Bar -->
       <div class="flex justify-between items-start">
           <div class="glass-panel rounded-xl p-5 pointer-events-auto max-w-md border-l-4 border-blue-600">
               <div class="flex items-center gap-3 mb-2">
                   <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-lg">T</div>
                   <div>
                       <h1 class="text-xl font-bold text-gray-900 tracking-tight">TRIG AUDIT SYSTEM</h1>
                       <p class="text-xs text-gray-500 font-medium uppercase tracking-wider">Pavilion Structural Analysis</p>
                   </div>
               </div>
               <div class="flex gap-3 text-xs mono mt-3">
                   <span class="px-3 py-1.5 bg-gray-100 rounded-lg text-gray-700 border border-gray-200 font-semibold">
                       STATUS: <span id="audit-status" class="text-amber-600">PENDING</span>
                   </span>
                   <span class="px-3 py-1.5 bg-blue-50 rounded-lg text-blue-700 border border-blue-200 font-semibold">
                       PROGRESS: <span id="progress">0</span>/3
                   </span>
               </div>
           </div>

           <!-- Tool Palette -->
           <div class="glass-panel rounded-xl p-2 pointer-events-auto flex flex-col gap-2 shadow-xl">
               <button onclick="setTool('measure')" id="btn-measure" class="tool-btn p-3 rounded-lg hover:bg-gray-100 transition-all border-2 border-transparent flex flex-col items-center gap-1 group">
                   <svg class="w-6 h-6 text-gray-600 group-hover:text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                   <span class="text-[10px] font-bold text-gray-500 group-hover:text-blue-600 uppercase">Measure</span>
               </button>
               <button onclick="setTool('angle')" id="btn-angle" class="tool-btn p-3 rounded-lg hover:bg-gray-100 transition-all border-2 border-transparent flex flex-col items-center gap-1 group">
                   <svg class="w-6 h-6 text-gray-600 group-hover:text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg>
                   <span class="text-[10px] font-bold text-gray-500 group-hover:text-blue-600 uppercase">Protractor</span>
               </button>
               <button onclick="setTool('calculate')" id="btn-calc" class="tool-btn p-3 rounded-lg hover:bg-gray-100 transition-all border-2 border-transparent flex flex-col items-center gap-1 group">
                   <svg class="w-6 h-6 text-gray-600 group-hover:text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                   <span class="text-[10px] font-bold text-gray-500 group-hover:text-blue-600 uppercase">Calculate</span>
               </button>
               <div class="h-px bg-gray-200 my-1"></div>
               <button onclick="toggleReport()" class="p-3 rounded-lg hover:bg-amber-50 transition-all border-2 border-transparent flex flex-col items-center gap-1 group">
                   <svg class="w-6 h-6 text-gray-600 group-hover:text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                   <span class="text-[10px] font-bold text-gray-500 group-hover:text-amber-600 uppercase">Report</span>
               </button>
           </div>
       </div>

       <!-- Bottom Info -->
       <div class="flex justify-between items-end">
           <div class="glass-panel rounded-xl p-5 pointer-events-auto max-w-sm shadow-lg">
               <h3 class="text-sm font-bold text-gray-800 mb-2 flex items-center gap-2">
                   <span class="w-2 h-2 bg-blue-600 rounded-full"></span>
                   MISSION BRIEF
               </h3>
               <p class="text-sm text-gray-600 leading-relaxed mb-3">
                   Analyze the pavilion's triangular trusses. Calculate <strong>3 critical unknowns</strong> using trigonometric laws to certify structural safety.
               </p>
               <div class="flex items-center gap-2 mb-3">
                   <span class="text-xs font-semibold text-gray-500 uppercase">Current Tool:</span>
                   <span id="current-tool" class="mono text-sm font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">None Selected</span>
               </div>
               <div id="instruction-box" class="p-3 bg-amber-50 border-l-4 border-amber-400 rounded-r text-sm text-amber-800 font-medium">
                   Select a tool to begin analysis...
               </div>
           </div>

           <!-- Live Measurements -->
           <div class="glass-panel rounded-xl p-5 pointer-events-auto min-w-[220px] shadow-lg">
               <h3 class="text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider flex items-center gap-2">
                   <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                   Live Telemetry
               </h3>
               <div class="space-y-3 mono text-sm">
                   <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                       <span class="text-gray-500 font-medium">Distance</span>
                       <span id="live-dist" class="text-blue-600 font-bold text-lg">--</span>
                   </div>
                   <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                       <span class="text-gray-500 font-medium">Angle</span>
                       <span id="live-angle" class="text-amber-600 font-bold text-lg">--</span>
                   </div>
                   <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                       <span class="text-gray-500 font-medium">Selected</span>
                       <span id="live-verts" class="text-gray-800 font-bold">0 pts</span>
                   </div>
               </div>
           </div>
       </div>
   </div>

   <!-- Calculation Modal -->
   <div id="calc-modal" class="hidden absolute inset-0 z-50 flex items-center justify-center bg-white/60 backdrop-blur-md">
       <div class="glass-panel rounded-2xl p-8 max-w-3xl w-full mx-4 max-h-[85vh] overflow-y-auto shadow-2xl border border-gray-200">
           <div class="flex justify-between items-center mb-6 border-b border-gray-200 pb-4">
               <div>
                   <h2 class="text-2xl font-bold text-gray-900">Trigonometric Calculator</h2>
                   <p class="text-sm text-gray-500 mt-1">Solve for unknown measurements using geometric laws</p>
               </div>
               <button onclick="closeCalc()" class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center text-gray-400 hover:text-gray-600 transition">
                   <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
               </button>
           </div>
           
           <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
               <div>
                   <h3 class="text-sm font-bold text-gray-700 mb-4 uppercase tracking-wider">Select Triangle Component</h3>
                   <div class="space-y-3" id="triangle-list">
                       <!-- Populated by JS -->
                   </div>
               </div>
               
               <div id="calc-workspace" class="hidden">
                   <h3 class="text-sm font-bold text-gray-700 mb-4 uppercase tracking-wider">Analysis Workspace</h3>
                   <div class="bg-gray-50 rounded-xl p-6 mono text-sm space-y-4 border border-gray-200" id="calc-steps">
                       <!-- Calculation steps appear here -->
                   </div>
                   
                   <div class="mt-6 p-5 bg-amber-50 border-2 border-amber-200 rounded-xl">
                       <label class="text-sm text-amber-800 block mb-2 font-bold">Your Calculated Result:</label>
                       <div class="flex gap-3">
                           <input type="number" id="user-answer" step="0.01" class="flex-1 bg-white border-2 border-amber-300 rounded-lg px-4 py-3 text-gray-900 mono font-bold text-lg focus:outline-none focus:border-amber-500" placeholder="0.00">
                           <button onclick="verifyCalculation()" class="btn-primary px-6 py-3 rounded-lg font-bold text-sm uppercase tracking-wider">Verify</button>
                       </div>
                       <p class="text-xs text-amber-600 mt-2 font-medium">Enter value in meters (2 decimal places)</p>
                   </div>
               </div>
           </div>
       </div>
   </div>

   <!-- Safety Report Booklet -->
   <div id="report-panel" class="hidden absolute right-0 top-0 bottom-0 w-full md:w-[550px] z-40 glass-panel border-l border-gray-200 overflow-y-auto transform transition-transform duration-300 translate-x-full shadow-2xl">
       <div class="p-8">
           <div class="flex justify-between items-start mb-8 border-b-2 border-gray-100 pb-6">
               <div>
                   <div class="flex items-center gap-3 mb-2">
                       <div class="w-12 h-12 bg-gradient-to-br from-blue-600 to-purple-600 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg">S</div>
                       <div>
                           <h2 class="text-2xl font-bold text-gray-900">SAFETY REPORT</h2>
                           <p class="text-xs text-gray-400 mono mt-1 font-semibold">DOC#: PAV-2024-TRIG-001</p>
                       </div>
                   </div>
               </div>
               <button onclick="toggleReport()" class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center text-gray-400 hover:text-gray-600 transition">
                   <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
               </button>
           </div>

           <div class="space-y-8">
               <!-- Executive Summary -->
               <section class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-100">
                   <h3 class="text-sm font-bold text-blue-900 uppercase tracking-wider mb-3 flex items-center gap-2">
                       <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                       Executive Summary
                   </h3>
                   <div class="text-sm text-gray-700 leading-relaxed">
                       Structural analysis of the Geometric Pavilion reveals <span id="report-status" class="text-amber-600 font-bold text-lg">PENDING COMPLETION</span>. 
                       Three critical measurements require verification using trigonometric methods before construction approval.
                   </div>
               </section>

               <!-- Structural Analysis -->
               <section>
                   <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wider mb-4 flex items-center gap-2">
                       <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                       Structural Deconstruction
                   </h3>
                   <div class="space-y-4">
                       <div class="flex items-start gap-4 p-4 bg-white rounded-xl border-2 border-gray-100 hover:border-blue-200 transition shadow-sm">
                           <div class="w-12 h-12 rounded-xl bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-lg shrink-0">Δ1</div>
                           <div class="flex-1">
                               <div class="text-base font-bold text-gray-900 mb-1">Right Triangle: Foundation</div>
                               <div class="text-sm text-gray-600 mb-2">Base: 8m | Height: 5m | Hypotenuse: <span class="text-amber-600 font-mono font-bold">?</span></div>
                               <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-700">SOH CAH TOA / Pythagorean</span>
                           </div>
                       </div>
                       
                       <div class="flex items-start gap-4 p-4 bg-white rounded-xl border-2 border-gray-100 hover:border-purple-200 transition shadow-sm">
                           <div class="w-12 h-12 rounded-xl bg-purple-100 flex items-center justify-center text-purple-600 font-bold text-lg shrink-0">Δ2</div>
                           <div class="flex-1">
                               <div class="text-base font-bold text-gray-900 mb-1">Non-Right: Roof Truss A</div>
                               <div class="text-sm text-gray-600 mb-2">Sides: 6m, 7m | Included Angle: 65° | Opposite: <span class="text-amber-600 font-mono font-bold">?</span></div>
                               <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-purple-100 text-purple-700">Cosine Rule</span>
                           </div>
                       </div>

                       <div class="flex items-start gap-4 p-4 bg-white rounded-xl border-2 border-gray-100 hover:border-green-200 transition shadow-sm">
                           <div class="w-12 h-12 rounded-xl bg-green-100 flex items-center justify-center text-green-600 font-bold text-lg shrink-0">Δ3</div>
                           <div class="flex-1">
                               <div class="text-base font-bold text-gray-900 mb-1">Non-Right: Support Beam</div>
                               <div class="text-sm text-gray-600 mb-2">Angles: 45°, 60° | Side: 4m | Unknown: <span class="text-amber-600 font-mono font-bold">?</span></div>
                               <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700">Sine Rule</span>
                           </div>
                       </div>
                   </div>
               </section>

               <!-- Verified Calculations -->
               <section>
                   <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wider mb-4 flex items-center gap-2">
                       <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                       Verified Calculations
                   </h3>
                   <div id="verified-calcs" class="space-y-3">
                       <div class="p-6 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200 text-center">
                           <svg class="w-12 h-12 text-gray-300 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                           <p class="text-sm text-gray-400 font-medium">No calculations verified yet...</p>
                           <p class="text-xs text-gray-400 mt-1">Complete the trigonometric analysis to populate this section</p>
                       </div>
                   </div>
               </section>

               <!-- Safety Rating -->
               <section class="pt-6 border-t-2 border-gray-100">
                   <div class="flex items-center justify-between mb-4">
                       <span class="text-sm font-bold text-gray-700 uppercase tracking-wider">Structural Integrity Score</span>
                       <span id="integrity-score" class="text-4xl font-black text-gray-300">--%</span>
                   </div>
                   <div class="h-4 bg-gray-200 rounded-full overflow-hidden shadow-inner">
                       <div id="score-bar" class="h-full bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 w-0 transition-all duration-1000 shadow-lg"></div>
                   </div>
                   <div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                       <p id="final-verdict" class="text-sm text-gray-500 text-center font-medium">Complete all calculations to generate safety rating</p>
                   </div>
               </section>
           </div>
       </div>
   </div>

   <script>
       // Game State
       const state = {
           tool: null,
           measurements: [],
           selectedPoints: [],
           solvedTriangles: [],
           triangles: [
               {
                   id: 1,
                   name: "Foundation Right-Triangle",
                   type: "right",
                   vertices: [[0,0,0], [8,0,0], [0,5,0]],
                   known: { base: 8, height: 5, angle: 90 },
                   unknown: { hypotenuse: null, angleA: null, angleB: null },
                   method: "pythagorean",
                   solved: false
               },
               {
                   id: 2,
                   name: "Roof Truss A (SAS)",
                   type: "non-right",
                   vertices: [[8,0,0], [12,6,0], [4,6,0]],
                   known: { sideA: 6, sideB: 7, angleC: 65 },
                   unknown: { sideC: null, angleA: null, angleB: null },
                   method: "cosine",
                   solved: false
               },
               {
                   id: 3,
                   name: "Support Beam (AAS)",
                   type: "non-right",
                   vertices: [[0,5,0], [4,8,0], [2,5,4]],
                   unknown: { sideB: null, sideC: null, angleC: null },
                   method: "sine",
                   solved: false
               }
           ]
       };

       // Three.js Setup
       let scene, camera, renderer, controls;
       let raycaster, mouse;
       let pavilionGroup;
       let selectedObject = null;
       let markers = [];

       function init() {
           const container = document.getElementById('canvas-container');
           
           // Scene - Light theme background
           scene = new THREE.Scene();
           scene.background = new THREE.Color(0xf5f5f0);
           scene.fog = new THREE.Fog(0xf5f5f0, 20, 100);

           // Camera
           camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
           camera.position.set(20, 15, 20);

           // Renderer
           renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
           renderer.setSize(window.innerWidth, window.innerHeight);
           renderer.setPixelRatio(window.devicePixelRatio);
           renderer.shadowMap.enabled = true;
           renderer.shadowMap.type = THREE.PCFSoftShadowMap;
           container.appendChild(renderer.domElement);

           // Controls
           controls = new THREE.OrbitControls(camera, renderer.domElement);
           controls.enableDamping = true;
           controls.dampingFactor = 0.05;
           controls.maxPolarAngle = Math.PI / 2;
           controls.minDistance = 10;
           controls.maxDistance = 50;

           // Lighting - Bright, professional studio lighting
           const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
           scene.add(ambientLight);

           const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
           dirLight.position.set(10, 20, 10);
           dirLight.castShadow = true;
           dirLight.shadow.mapSize.width = 2048;
           dirLight.shadow.mapSize.height = 2048;
           scene.add(dirLight);

           const fillLight = new THREE.DirectionalLight(0xe0e8ff, 0.4);
           fillLight.position.set(-10, 10, -10);
           scene.add(fillLight);

           // Grid - subtle
           const gridHelper = new THREE.GridHelper(40, 40, 0xcccccc, 0xe5e5e5);
           scene.add(gridHelper);

           // Build Pavilion
           buildPavilion();

           // Raycaster
           raycaster = new THREE.Raycaster();
           mouse = new THREE.Vector2();

           // Event Listeners
           window.addEventListener('resize', onWindowResize);
           renderer.domElement.addEventListener('click', onMouseClick);
           renderer.domElement.addEventListener('mousemove', onMouseMove);

           animate();
       }

       function buildPavilion() {
           pavilionGroup = new THREE.Group();

           // WHITE materials for the structure
           const beamMat = new THREE.MeshStandardMaterial({ 
               color: 0xffffff, 
               metalness: 0.1, 
               roughness: 0.1,
               emissive: 0xf0f0f0,
               emissiveIntensity: 0.1
           });
           
           const highlightMat = new THREE.MeshStandardMaterial({ 
               color: 0x0066ff, 
               emissive: 0x0066ff,
               emissiveIntensity: 0.3,
               transparent: true,
               opacity: 0.9
           });
           
           const jointMat = new THREE.MeshStandardMaterial({ 
               color: 0xff3300, 
               metalness: 0.3, 
               roughness: 0.4 
           });

           // Triangle 1: Foundation (Right) - BLUE tint
           const t1 = state.triangles[0];
           createTriangleBeam(t1.vertices, new THREE.MeshStandardMaterial({ 
               color: 0xe8f4ff, 
               metalness: 0.1, 
               roughness: 0.1,
               emissive: 0x0066ff,
               emissiveIntensity: 0.05
           }), jointMat, 0.2);
           
           // Triangle 2: Roof (SAS) - PURPLE tint
           const t2 = state.triangles[1];
           createTriangleBeam(t2.vertices, new THREE.MeshStandardMaterial({ 
               color: 0xf3e8ff, 
               metalness: 0.1, 
               roughness: 0.1,
               emissive: 0x6600ff,
               emissiveIntensity: 0.05
           }), jointMat, 0.15);
           
           // Triangle 3: Support (AAS) - GREEN tint
           const t3 = state.triangles[2];
           createTriangleBeam(t3.vertices, new THREE.MeshStandardMaterial({ 
               color: 0xe8fff0, 
               metalness: 0.1, 
               roughness: 0.1,
               emissive: 0x00ff66,
               emissiveIntensity: 0.05
           }), jointMat, 0.12);

           // Add measurement points
           const allVerts = [...t1.vertices, ...t2.vertices, ...t3.vertices];
           const uniqueVerts = [];
           
           allVerts.forEach(v => {
               if (!uniqueVerts.some(uv => 
                   Math.abs(uv[0]-v[0])<0.1 && Math.abs(uv[1]-v[1])<0.1 && Math.abs(uv[2]-v[2])<0.1)) {
                   uniqueVerts.push(v);
               }
           });

           uniqueVerts.forEach((v, i) => {
               const geom = new THREE.SphereGeometry(0.25, 16, 16);
               const mesh = new THREE.Mesh(geom, highlightMat.clone());
               mesh.position.set(...v);
               mesh.userData = { type: 'vertex', id: i, coords: v };
               mesh.visible = false;
               pavilionGroup.add(mesh);
               markers.push(mesh);
           });

           scene.add(pavilionGroup);
       }

       function createTriangleBeam(vertices, beamMat, jointMat, thickness) {
           for (let i = 0; i < 3; i++) {
               const start = new THREE.Vector3(...vertices[i]);
               const end = new THREE.Vector3(...vertices[(i+1)%3]);
               const distance = start.distanceTo(end);
               
               const geom = new THREE.CylinderGeometry(thickness, thickness, distance, 16);
               const beam = new THREE.Mesh(geom, beamMat);
               
               const midpoint = new THREE.Vector3().addVectors(start, end).multiplyScalar(0.5);
               beam.position.copy(midpoint);
               beam.lookAt(end);
               beam.rotateX(Math.PI/2);
               
               beam.castShadow = true;
               beam.receiveShadow = true;
               beam.userData = { type: 'beam', length: distance };
               pavilionGroup.add(beam);

               const jointGeom = new THREE.SphereGeometry(thickness*1.8, 16, 16);
               const joint = new THREE.Mesh(jointGeom, jointMat);
               joint.position.copy(start);
               joint.castShadow = true;
               pavilionGroup.add(joint);
           }
       }

       function setTool(toolName) {
           state.tool = toolName;
           state.selectedPoints = [];
           
           document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('tool-active'));
           document.getElementById(`btn-${toolName}`).classList.add('tool-active');
           
           const toolNames = {
               'measure': 'Distance Measurement',
               'angle': 'Angle Protractor',
               'calculate': 'Trigonometric Calculator'
           };
           document.getElementById('current-tool').textContent = toolNames[toolName];
           
           markers.forEach(m => m.visible = (toolName === 'measure' || toolName === 'angle'));
           
           const instructions = {
               'measure': 'Click two blue vertex points to measure distance between them.',
               'angle': 'Click three points: vertex first, then two points forming the angle arms.',
               'calculate': 'Open the calculator panel to solve for unknown measurements.'
           };
           const instructionBox = document.getElementById('instruction-box');
           instructionBox.textContent = instructions[toolName];
           instructionBox.className = 'mt-3 p-3 bg-blue-50 border-l-4 border-blue-500 rounded-r text-sm text-blue-800 font-medium';
           
           if (toolName === 'calculate') {
               openCalc();
           }
           
           clearMeasurements();
       }

       function onMouseClick(event) {
           if (!state.tool || state.tool === 'calculate') return;
           
           mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
           mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
           
           raycaster.setFromCamera(mouse, camera);
           const intersects = raycaster.intersectObjects(markers);
           
           if (intersects.length > 0) {
               const point = intersects[0].object;
               handlePointSelection(point);
           }
       }

       function handlePointSelection(point) {
           if (state.tool === 'measure') {
               if (state.selectedPoints.length < 2) {
                   state.selectedPoints.push(point);
                   point.material.emissiveIntensity = 0.8;
                   point.scale.set(1.5, 1.5, 1.5);
                   
                   if (state.selectedPoints.length === 2) {
                       const p1 = state.selectedPoints[0].position;
                       const p2 = state.selectedPoints[1].position;
                       const dist = p1.distanceTo(p2).toFixed(2);
                       document.getElementById('live-dist').textContent = dist + 'm';
                       drawMeasurementLine(p1, p2, dist);
                       
                       setTimeout(() => {
                           state.selectedPoints.forEach(p => {
                               p.material.emissiveIntensity = 0.3;
                               p.scale.set(1, 1, 1);
                           });
                           state.selectedPoints = [];
                       }, 2000);
                   }
               }
           } else if (state.tool === 'angle') {
               if (state.selectedPoints.length < 3) {
                   state.selectedPoints.push(point);
                   point.material.emissiveIntensity = 0.8;
                   point.scale.set(1.5, 1.5, 1.5);
                   
                   if (state.selectedPoints.length === 3) {
                       const angle = calculateAngle(
                           state.selectedPoints[1].position,
                           state.selectedPoints[0].position,
                           state.selectedPoints[2].position
                       );
                       document.getElementById('live-angle').textContent = angle.toFixed(1) + '°';
                       
                       setTimeout(() => {
                           state.selectedPoints.forEach(p => {
                               p.material.emissiveIntensity = 0.3;
                               p.scale.set(1, 1, 1);
                           });
                           state.selectedPoints = [];
                       }, 2000);
                   }
               }
           }
           document.getElementById('live-verts').textContent = state.selectedPoints.length + ' pts';
       }

       function calculateAngle(p1, vertex, p2) {
           const v1 = new THREE.Vector3().subVectors(p1, vertex).normalize();
           const v2 = new THREE.Vector3().subVectors(p2, vertex).normalize();
           return Math.acos(v1.dot(v2)) * (180/Math.PI);
       }

       function drawMeasurementLine(p1, p2, dist) {
           const material = new THREE.LineBasicMaterial({ color: 0xff3300, linewidth: 3 });
           const geometry = new THREE.BufferGeometry().setFromPoints([p1, p2]);
           const line = new THREE.Line(geometry, material);
           scene.add(line);
           
           setTimeout(() => scene.remove(line), 3000);
       }

       function clearMeasurements() {
           document.getElementById('live-dist').textContent = '--';
           document.getElementById('live-angle').textContent = '--';
           document.getElementById('live-verts').textContent = '0 pts';
       }

       function openCalc() {
           document.getElementById('calc-modal').classList.remove('hidden');
           populateTriangleList();
       }

       function closeCalc() {
           document.getElementById('calc-modal').classList.add('hidden');
           document.getElementById('calc-workspace').classList.add('hidden');
       }

       function populateTriangleList() {
           const list = document.getElementById('triangle-list');
           list.innerHTML = '';
           
           state.triangles.forEach(tri => {
               const div = document.createElement('div');
               const colors = {
                   'pythagorean': 'blue',
                   'cosine': 'purple', 
                   'sine': 'green'
               };
               const color = colors[tri.method];
               
               div.className = `p-4 rounded-xl border-2 cursor-pointer transition-all hover:shadow-md ${tri.solved ? `bg-${color}-50 border-${color}-500` : 'bg-white border-gray-200 hover:border-gray-300'}`;
               div.innerHTML = `
                   <div class="flex justify-between items-center mb-2">
                       <span class="font-bold text-gray-900 ${tri.solved ? `text-${color}-700` : ''}">${tri.name}</span>
                       ${tri.solved ? `<span class="status-badge bg-${color}-600">✓ VERIFIED</span>` : '<span class="px-3 py-1 rounded-full text-xs font-bold bg-amber-100 text-amber-700">PENDING</span>'}
                   </div>
                   <div class="text-xs text-gray-500 font-medium uppercase tracking-wider">Method: ${tri.method}</div>
               `;
               div.onclick = () => selectTriangle(tri);
               list.appendChild(div);
           });
       }

       function selectTriangle(tri) {
           if (tri.solved) {
               alert('This component has already been certified!');
               return;
           }
           
           document.getElementById('calc-workspace').classList.remove('hidden');
           const steps = document.getElementById('calc-steps');
           steps.innerHTML = '';
           
           if (tri.method === 'pythagorean') {
               const c = Math.sqrt(tri.known.base**2 + tri.known.height**2);
               steps.innerHTML = `
                   <div class="math-step">
                       <div class="text-blue-700 font-bold mb-2 text-sm uppercase">Given Values</div>
                       <div class="grid grid-cols-2 gap-2 text-gray-700">
                           <div>Base (a) = <span class="font-bold">${tri.known.base}m</span></div>
                           <div>Height (b) = <span class="font-bold">${tri.known.height}m</span></div>
                           <div class="col-span-2">Angle C = <span class="font-bold">90°</span> (Right Triangle)</div>
                       </div>
                   </div>
                   <div class="math-step">
                       <div class="text-blue-700 font-bold mb-2 text-sm uppercase">Objective</div>
                       <div class="text-gray-700">Find Hypotenuse (c)</div>
                   </div>
                   <div class="math-step bg-blue-50">
                       <div class="text-blue-700 font-bold mb-2 text-sm uppercase">Pythagorean Theorem</div>
                       <div class="text-lg font-bold text-gray-900 mb-1">c² = a² + b²</div>
                       <div class="text-sm text-gray-600">Therefore: c = √(a² + b²)</div>
                   </div>
                   <div class="math-step">
                       <div class="text-blue-700 font-bold mb-2 text-sm uppercase">Substitution</div>
                       <div class="space-y-1 text-gray-700 font-mono text-sm">
                           <div>c = √(${tri.known.base}² + ${tri.known.height}²)</div>
                           <div>c = √(${tri.known.base**2} + ${tri.known.height**2})</div>
                           <div>c = √${tri.known.base**2 + tri.known.height**2}</div>
                       </div>
                   </div>
               `;
               window.currentExpected = c;
           } else if (tri.method === 'cosine') {
               const c = Math.sqrt(tri.known.sideA**2 + tri.known.sideB**2 - 2*tri.known.sideA*tri.known.sideB*Math.cos(tri.known.angleC * Math.PI/180));
               steps.innerHTML = `
                   <div class="math-step">
                       <div class="text-purple-700 font-bold mb-2 text-sm uppercase">Given (SAS Configuration)</div>
                       <div class="grid grid-cols-2 gap-2 text-gray-700">
                           <div>Side a = <span class="font-bold">${tri.known.sideA}m</span></div>
                           <div>Side b = <span class="font-bold">${tri.known.sideB}m</span></div>
                           <div class="col-span-2">Angle C = <span class="font-bold">${tri.known.angleC}°</span></div>
                       </div>
                   </div>
                   <div class="math-step bg-purple-50">
                       <div class="text-purple-700 font-bold mb-2 text-sm uppercase">Cosine Rule</div>
                       <div class="text-lg font-bold text-gray-900 mb-1">c² = a² + b² - 2ab·cos(C)</div>
                   </div>
                   <div class="math-step">
                       <div class="text-purple-700 font-bold mb-2 text-sm uppercase">Calculation</div>
                       <div class="space-y-1 text-gray-700 font-mono text-sm">
                           <div>c² = ${tri.known.sideA}² + ${tri.known.sideB}² - 2(${tri.known.sideA})(${tri.known.sideB})·cos(${tri.known.angleC}°)</div>
                           <div>c² = ${tri.known.sideA**2} + ${tri.known.sideB**2} - ${(2*tri.known.sideA*tri.known.sideB).toFixed(0)}·${Math.cos(tri.known.angleC * Math.PI/180).toFixed(4)}</div>
                           <div>c² = ${(c**2).toFixed(2)}</div>
                       </div>
                   </div>
               `;
               window.currentExpected = c;
           } else if (tri.method === 'sine') {
               const angleC = 180 - 45 - 60;
               const sideB = (4 * Math.sin(60 * Math.PI/180)) / Math.sin(45 * Math.PI/180);
               steps.innerHTML = `
                   <div class="math-step">
                       <div class="text-green-700 font-bold mb-2 text-sm uppercase">Given (AAS Configuration)</div>
                       <div class="grid grid-cols-2 gap-2 text-gray-700">
                           <div>Angle A = <span class="font-bold">45°</span></div>
                           <div>Angle B = <span class="font-bold">60°</span></div>
                           <div>Side a = <span class="font-bold">4m</span></div>
                       </div>
                   </div>
                   <div class="math-step">
                       <div class="text-green-700 font-bold mb-2 text-sm uppercase">Step 1: Find Angle C</div>
                       <div class="text-gray-700 font-mono">C = 180° - 45° - 60° = <span class="font-bold text-green-700">${angleC}°</span></div>
                   </div>
                   <div class="math-step bg-green-50">
                       <div class="text-green-700 font-bold mb-2 text-sm uppercase">Step 2: Sine Rule</div>
                       <div class="text-lg font-bold text-gray-900 mb-1">a/sin(A) = b/sin(B)</div>
                       <div class="text-sm text-gray-600">Therefore: b = a·sin(B)/sin(A)</div>
                   </div>
               `;
               window.currentExpected = sideB;
           }
           
           window.currentCalcTriangle = tri;
       }

       function verifyCalculation() {
           const tri = window.currentCalcTriangle;
           const userVal = parseFloat(document.getElementById('user-answer').value);
           const correct = window.currentExpected;
           
           if (!userVal || isNaN(userVal)) {
               alert('Please enter a valid number');
               return;
           }
           
           if (Math.abs(userVal - correct) < 0.15) {
               tri.solved = true;
               state.solvedTriangles.push(tri);
               updateProgress();
               addToReport(tri, correct);
               closeCalc();
               populateTriangleList();
               highlightSolvedTriangle(tri);
               
               // Success feedback
               const btn = document.querySelector(`#btn-calc`);
               btn.classList.add('bg-green-100', 'text-green-700', 'border-green-500');
               setTimeout(() => btn.classList.remove('bg-green-100', 'text-green-700', 'border-green-500'), 1000);
           } else {
               const diff = Math.abs(userVal - correct).toFixed(2);
               alert(`Calculation error detected. Difference: ${diff}m\nExpected: ${correct.toFixed(2)}m\n\nCheck your trigonometric steps.`);
           }
       }

       function highlightSolvedTriangle(tri) {
           const flash = new THREE.PointLight(0x00ff00, 1, 15);
           flash.position.set(...tri.vertices[0]);
           scene.add(flash);
           
           // Animate flash
           let intensity = 1;
           const fade = setInterval(() => {
               intensity -= 0.05;
               flash.intensity = intensity;
               if (intensity <= 0) {
                   clearInterval(fade);
                   scene.remove(flash);
               }
           }, 50);
       }

       function updateProgress() {
           const progress = state.solvedTriangles.length;
           document.getElementById('progress').textContent = progress;
           
           if (progress === 3) {
               document.getElementById('audit-status').textContent = 'COMPLETE';
               document.getElementById('audit-status').className = 'text-green-600 font-bold';
               generateFinalReport();
           }
       }

       function addToReport(tri, value) {
           const container = document.getElementById('verified-calcs');
           if (state.solvedTriangles.length === 1) container.innerHTML = '';
           
           const colors = {
               'pythagorean': 'blue',
               'cosine': 'purple',
               'sine': 'green'
           };
           const color = colors[tri.method];
           
           const div = document.createElement('div');
           div.className = `p-4 bg-${color}-50 border-l-4 border-${color}-500 rounded-r-lg shadow-sm`;
           div.innerHTML = `
               <div class="flex justify-between items-start mb-2">
                   <span class="font-bold text-${color}-900">${tri.name}</span>
                   <span class="text-lg font-black text-${color}-700 mono">${value.toFixed(2)}m</span>
               </div>
               <div class="flex items-center gap-2 text-xs text-${color}-700 font-medium uppercase tracking-wider">
                   <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                   ${tri.method.toUpperCase()} METHOD VERIFIED
               </div>
           `;
           container.appendChild(div);
       }

       function generateFinalReport() {
           const score = 100;
           const scoreEl = document.getElementById('integrity-score');
           scoreEl.textContent = score + '%';
           scoreEl.className = 'text-4xl font-black text-green-600';
           
           document.getElementById('score-bar').style.width = '100%';
           
           const verdict = document.getElementById('final-verdict');
           verdict.textContent = '✓ STRUCTURE CLEARED FOR CONSTRUCTION';
           verdict.className = 'mt-4 text-lg text-green-700 font-bold text-center bg-green-50 py-3 rounded-lg border border-green-200';
           
           document.getElementById('report-status').textContent = 'STABLE';
           document.getElementById('report-status').className = 'text-green-600 font-bold text-lg';
       }

       function toggleReport() {
           const panel = document.getElementById('report-panel');
           if (panel.classList.contains('hidden')) {
               panel.classList.remove('hidden');
               setTimeout(() => panel.classList.remove('translate-x-full'), 10);
           } else {
               panel.classList.add('translate-x-full');
               setTimeout(() => panel.classList.add('hidden'), 300);
           }
       }

       function onMouseMove(event) {
           mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
           mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
           
           if (state.tool === 'measure' || state.tool === 'angle') {
               raycaster.setFromCamera(mouse, camera);
               const intersects = raycaster.intersectObjects(markers);
               document.body.style.cursor = intersects.length > 0 ? 'pointer' : 'crosshair';
           } else {
               document.body.style.cursor = 'default';
           }
       }

       function onWindowResize() {
           camera.aspect = window.innerWidth / window.innerHeight;
           camera.updateProjectionMatrix();
           renderer.setSize(window.innerWidth, window.innerHeight);
       }

       function animate() {
           requestAnimationFrame(animate);
           controls.update();
           
           if (pavilionGroup && !state.tool) {
               pavilionGroup.rotation.y += 0.0005;
           }
           
           // Gentle floating animation for markers when visible
           markers.forEach((m, i) => {
               if (m.visible) {
                   m.position.y += Math.sin(Date.now() * 0.002 + i) * 0.002;
               }
           });
           
           renderer.render(scene, camera);
       }

       init();
   </script>
</body>
</html>